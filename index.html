<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFA Tracker Pro - EUR Only</title>
    <style>
        /* Restoring your original high-end CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 30px; margin-bottom: 30px; text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header h1 { color: #2c3e50; font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
        .year-nav { margin: 15px 0; }
        .year-nav select {
            padding: 10px 20px; border-radius: 10px; border: 2px solid #667eea;
            font-weight: bold; cursor: pointer; background: white;
        }
        .tabs {
            display: flex; background: rgba(255, 255, 255, 0.95);
            border-radius: 15px; margin-bottom: 30px; overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .tab-btn {
            flex: 1; padding: 20px; background: none; border: none;
            cursor: pointer; font-size: 1rem; font-weight: 600; color: #7f8c8d;
            transition: all 0.3s ease;
        }
        .tab-btn.active { background: #667eea; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: rgba(255, 255, 255, 0.95); border-radius: 15px;
            padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 25px; border-radius: 15px; text-align: center;
        }
        .stat-card .amount { font-size: 2rem; font-weight: 700; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        th { background: #f8f9fa; font-weight: 600; }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; }
        button.primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 15px 30px; border-radius: 10px;
            font-weight: 600; cursor: pointer; width: 100%;
        }
        .action-btn { padding: 8px 12px; border-radius: 8px; border: none; color: white; cursor: pointer; font-size: 0.85rem; margin-right: 5px; }
        .edit-btn { background: #f39c12; }
        .delete-btn { background: #e74c3c; }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 20px; border-radius: 10px;
            background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: none; z-index: 1000;
        }
    </style>
</head>
<body>

    <div class="container" id="mainApp">
        <div class="header">
            <h1>üí∞ PFA Tracker <span id="yearDisplay">2026</span></h1>
            <div class="year-nav">
                <select id="globalYear" onchange="changeYear(this.value)">
                    <option value="2025">An Fiscal 2025</option>
                    <option value="2026" selected>An Fiscal 2026</option>
                </select>
            </div>
            <p id="userMail" style="color: #7f8c8d; font-size: 0.9rem;"></p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab-btn" onclick="showTab('income', this)">üí∞ AdaugƒÉ Venit</button>
            <button class="tab-btn" onclick="showTab('history', this)">üìú Istoric</button>
            <button class="tab-btn" onclick="showTab('taxes', this)">‚öôÔ∏è Taxe</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card"><h4>Venit Brut</h4><div class="amount" id="dashBrut">0.00‚Ç¨</div></div>
                <div class="stat-card" style="background: #e74c3c;"><h4>Taxe Estimate</h4><div class="amount" id="dashTax">0.00‚Ç¨</div></div>
                <div class="stat-card" style="background: #27ae60;"><h4>Venit Net</h4><div class="amount" id="dashNet">0.00‚Ç¨</div></div>
            </div>
            <div class="card">
                <h3>Detaliu √éncasƒÉri <span class="yearLabel">2026</span></h3>
                <div id="monthlySummary" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="income" class="tab-content">
            <div class="card">
                <h3 id="formTitle">AdaugƒÉ Venit Nou</h3>
                <form id="incomeForm">
                    <input type="hidden" id="editId">
                    <div class="form-group"><label>Suma (EUR)</label><input type="number" id="amt" step="0.01" required></div>
                    <div class="form-group"><label>Data</label><input type="date" id="date" required></div>
                    <div class="form-group"><label>Sursa / Client</label><input type="text" id="src" required></div>
                    <button type="submit" class="primary-btn" id="submitBtn">SalveazƒÉ √énregistrarea</button>
                    <button type="button" id="cancelEdit" style="display:none; background:#95a5a6; margin-top:10px;" class="primary-btn" onclick="resetForm()">AnuleazƒÉ Editarea</button>
                </form>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="card">
                <h3>üìú Istoric Complet <span class="yearLabel">2026</span></h3>
                <table>
                    <thead>
                        <tr><th>Data</th><th>Sursa</th><th>Brut</th><th>Taxe</th><th>Net</th><th>Ac»õiuni</th></tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>

        <div id="taxes" class="tab-content">
            <div class="card">
                <h3>‚öôÔ∏è Configurare Taxe <span class="yearLabel">2026</span></h3>
                <form id="taxForm">
                    <div class="form-group">
                        <label>Suma FixƒÉ LunarƒÉ (CAS + CASS) √Æn EUR</label>
                        <input type="number" id="prov" step="0.01">
                        <small id="advice" style="color: #667eea; font-weight: bold;"></small>
                    </div>
                    <button type="submit" class="primary-btn">ActualizeazƒÉ Taxe <span class="yearLabel">2026</span></button>
                </form>
            </div>
        </div>
    </div>

    <div id="notif" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCV7t2agCZB_R1v4snh4wt0yYbHFHXs8xo",
            authDomain: "pfa-tracker-romania.firebaseapp.com",
            projectId: "pfa-tracker-romania",
            storageBucket: "pfa-tracker-romania.firebasestorage.app",
            messagingSenderId: "642912451003",
            appId: "1:642912451003:web:62b6859730937b43182c9e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let curUser = null;
        let entries = [];
        let activeYear = "2026";
        let yearTaxes = { "2025": { prov: 810 }, "2026": { prov: 891 } };

        auth.onAuthStateChanged(u => {
            if (u) {
                curUser = u;
                document.getElementById('userMail').textContent = u.email;
                loadData();
            } else {
                // Redirect to login if needed
            }
        });

        function showTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function changeYear(y) {
            activeYear = y;
            document.getElementById('yearDisplay').textContent = y;
            document.querySelectorAll('.yearLabel').forEach(l => l.textContent = y);
            document.getElementById('prov').value = yearTaxes[activeYear].prov;
            document.getElementById('advice').textContent = y === "2026" ? "Recomandat 2026 (Plafon 72): 891‚Ç¨" : "Recomandat 2025 (Plafon 60): 810‚Ç¨";
            render();
        }

        async function loadData() {
            const doc = await db.collection('users').doc(curUser.uid).get();
            if (doc.exists && doc.data().yearTaxes) yearTaxes = doc.data().yearTaxes;
            
            changeYear(activeYear);

            db.collection('users').doc(curUser.uid).collection('income').orderBy('date', 'desc').onSnapshot(snap => {
                entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        function render() {
            const filtered = entries.filter(e => e.date.startsWith(activeYear));
            const currentProv = yearTaxes[activeYear].prov;
            
            const monthMap = {};
            filtered.forEach(e => {
                const m = e.date.substring(0,7);
                if (!monthMap[m]) monthMap[m] = { total: 0, list: [] };
                monthMap[m].total += e.amount;
                monthMap[m].list.push(e);
            });

            let bSum = 0, tSum = 0;
            const hBody = document.getElementById('historyBody');
            const mSum = document.getElementById('monthlySummary');
            hBody.innerHTML = '';
            mSum.innerHTML = '';

            Object.keys(monthMap).sort().reverse().forEach(m => {
                monthMap[m].list.forEach(item => {
                    const share = item.amount / monthMap[m].total;
                    const tax = (currentProv * share) + (item.amount * 0.1);
                    const net = item.amount - tax;
                    
                    bSum += item.amount;
                    tSum += tax;

                    const row = `<tr>
                        <td>${item.date}</td><td><strong>${item.source}</strong></td>
                        <td>${item.amount.toFixed(2)}‚Ç¨</td><td style="color:#e74c3c">-${tax.toFixed(2)}‚Ç¨</td>
                        <td style="color:#27ae60; font-weight:bold">${net.toFixed(2)}‚Ç¨</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editEntry('${item.id}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteEntry('${item.id}')">»òterge</button>
                        </td>
                    </tr>`;
                    hBody.innerHTML += row;
                });
                
                mSum.innerHTML += `<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <span>${m}</span><strong>Brut: ${monthMap[m].total.toFixed(2)}‚Ç¨</strong>
                </div>`;
            });

            document.getElementById('dashBrut').textContent = bSum.toFixed(2) + '‚Ç¨';
            document.getElementById('dashTax').textContent = tSum.toFixed(2) + '‚Ç¨';
            document.getElementById('dashNet').textContent = (bSum - tSum).toFixed(2) + '‚Ç¨';
        }

        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const data = {
                amount: parseFloat(document.getElementById('amt').value),
                date: document.getElementById('date').value,
                source: document.getElementById('src').value
            };
            if (id) await db.collection('users').doc(curUser.uid).collection('income').doc(id).update(data);
            else await db.collection('users').doc(curUser.uid).collection('income').add(data);
            resetForm();
            showTab('history', document.querySelectorAll('.tab-btn')[2]);
        });

        document.getElementById('taxForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            yearTaxes[activeYear].prov = parseFloat(document.getElementById('prov').value);
            await db.collection('users').doc(curUser.uid).set({ yearTaxes }, { merge: true });
            render();
            alert("SetƒÉri salvate!");
        });

        function editEntry(id) {
            const e = entries.find(x => x.id === id);
            document.getElementById('editId').value = e.id;
            document.getElementById('amt').value = e.amount;
            document.getElementById('date').value = e.date;
            document.getElementById('src').value = e.source;
            document.getElementById('formTitle').textContent = "EditeazƒÉ √énregistrarea";
            document.getElementById('submitBtn').textContent = "SalveazƒÉ ModificƒÉrile";
            document.getElementById('cancelEdit').style.display = "block";
            showTab('income', document.querySelectorAll('.tab-btn')[1]);
        }

        function resetForm() {
            document.getElementById('incomeForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('formTitle').textContent = "AdaugƒÉ Venit Nou";
            document.getElementById('submitBtn').textContent = "SalveazƒÉ √énregistrarea";
            document.getElementById('cancelEdit').style.display = "none";
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        }

        async function deleteEntry(id) { if(confirm("»òtergi?")) await db.collection('users').doc(curUser.uid).collection('income').doc(id).delete(); }
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
